<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATLAS TITAN KIOSK</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body class="kiosk-body">
    
    <div style="position:absolute; width:100%; height:100%; background:url('https://www.transparenttextures.com/patterns/stardust.png'); opacity:0.1; animation:pulse 5s infinite;"></div>

    <div class="kiosk-content">
        
        <div class="kiosk-logo-wrapper">
            <div class="energy-ring ring-1"></div>
            <div class="energy-ring ring-2"></div>
            <div class="energy-ring ring-3"></div>
            <img src="Logo/ATLAS.png" class="kiosk-logo">
        </div>

        <h1 class="kiosk-title">ACCESO SOCIOS</h1>
        
        <input type="text" id="k-input" class="kiosk-input" maxlength="5" placeholder="_____" inputmode="numeric">
        <p class="kiosk-instruction">Digita tu código y presiona <b style="color:#fff">ENTER</b></p>

        <!-- Teclado Numérico Virtual (Solo visible en táctil) -->
        <div id="virtual-keypad" class="virtual-keypad">
            <button class="key-btn" onclick="pressKey('1')">1</button>
            <button class="key-btn" onclick="pressKey('2')">2</button>
            <button class="key-btn" onclick="pressKey('3')">3</button>
            <button class="key-btn" onclick="pressKey('4')">4</button>
            <button class="key-btn" onclick="pressKey('5')">5</button>
            <button class="key-btn" onclick="pressKey('6')">6</button>
            <button class="key-btn" onclick="pressKey('7')">7</button>
            <button class="key-btn" onclick="pressKey('8')">8</button>
            <button class="key-btn" onclick="pressKey('9')">9</button>
            <button class="key-btn action-btn" onclick="pressKey('DEL')"><i class="fas fa-backspace"></i></button>
            <button class="key-btn" onclick="pressKey('0')">0</button>
            <button class="key-btn action-btn enter-btn" onclick="pressKey('ENTER')"><i class="fas fa-arrow-right"></i></button>
        </div>

        <div id="k-msg" class="kiosk-message"></div>
        <div id="k-sub" class="kiosk-submessage"></div>
    </div>

    <script type="module">
        import { database } from './firebase-config.js';
        import { ref, get, push, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const db = {
            get: async (key) => {
                const snapshot = await get(ref(database, key));
                return snapshot.exists() ? snapshot.val() : null;
            },
            add: (collection, data) => {
                const newRef = push(ref(database, collection));
                set(newRef, data);
            }
        };
        
        const inp = document.getElementById('k-input');
        const msg = document.getElementById('k-msg');
        const sub = document.getElementById('k-sub');
        const body = document.body;

        // Detect Touch Device
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        if (isTouch) {
            // Mobile/Tablet: Disable native keyboard and auto-focus
            inp.setAttribute('readonly', 'true');
        } else {
            // Desktop: Keep focus for physical keyboard
            document.body.onclick = () => inp.focus();
            inp.focus();
        }

        // Virtual Keypad Logic
        window.pressKey = (key) => {
            if (key === 'DEL') {
                inp.value = inp.value.slice(0, -1);
            } else if (key === 'ENTER') {
                processCode();
            } else {
                if (inp.value.length < 5) {
                    inp.value += key;
                }
            }
        };

        async function processCode() {
            const code = inp.value;
            if (code.length < 1) return;

            inp.disabled = true;
            msg.innerHTML = '<span style="color:#fff; font-size:2rem;">PROCESANDO...</span>';

            try {
                const membersData = await db.get("members");
                if (!membersData) {
                    setErrorState("ERROR DE CONEXIÓN", "No se pudo cargar la base de datos");
                    db.add("visits", { code: code, name: "Desconocido", date: new Date().toISOString(), status: "error", reason: "Error BD" });
                    resetAfterDelay();
                    return;
                }

                const membersList = Object.values(membersData);
                const m = membersList.find(mem => mem.code === code);

                if (!m) {
                    setErrorState("Error: Código inexistente", "");
                    db.add("visits", { code: code, name: "Desconocido", date: new Date().toISOString(), status: "error", reason: "Código inexistente" });
                } else {
                    const days = Math.ceil((new Date(m.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));

                    if (days < 0) {
                        setErrorState(`Membresía vencida el día ${new Date(m.expiryDate).toLocaleDateString()}`, "");
                        db.add("visits", { code: code, name: m.name, date: new Date().toISOString(), status: "expired", reason: "Membresía Vencida" });
                    } else {
                        setSuccessState(m.name, days, m.expiryDate);
                        db.add("visits", { code: code, name: m.name, date: new Date().toISOString(), status: "success" });
                    }
                }
            } catch (err) {
                console.error(err);
                setErrorState("ERROR SISTEMA", "Intenta de nuevo");
                db.add("visits", { code: code, name: "Sistema", date: new Date().toISOString(), status: "error", reason: "System Error" });
            }
            
            resetAfterDelay();
        }

        inp.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                processCode();
            }
        });
        
        function resetAfterDelay() {
            setTimeout(() => {
                inp.value = '';
                inp.disabled = false;
                inp.focus();
                resetState();
            }, 4000);
        }

        function setSuccessState(name, days, expiryDate) {
            body.style.transition = "background-color 0.5s ease";
            body.style.backgroundColor = '#00cc33';
            body.style.backgroundImage = 'none';
            msg.innerHTML = `<span style="font-size:3.5rem; text-shadow:0 0 30px rgba(0,0,0,0.5); color:#fff; font-weight:800;">¡Bienvenido ${name.split(' ')[0]}!</span>`;
            
            const expiryMessage = `Tu membresía vence el: <b>${new Date(expiryDate).toLocaleDateString()}</b>`;
            const daysMessage = days <= 5 ? `⚠️ Quedan ${days} días` : `✅ Acceso Autorizado`;
            
            sub.innerHTML = `${daysMessage}<br><span style="font-size:1.2rem; color: #e0e0e0;">${expiryMessage}</span>`;
        }

        function setErrorState(title, subtitle) {
            body.style.transition = "background-color 0.3s ease";
            body.style.backgroundColor = '#d32f2f';
            body.style.backgroundImage = 'none';
            msg.innerHTML = `<span style="font-size:3.5rem; color:#fff; font-weight:800;"><i class="fas fa-times-circle"></i> ${title}</span>`;
            sub.innerHTML = subtitle;
        }

        function resetState() {
            body.style.backgroundColor = '#000';
            body.style.backgroundImage = "radial-gradient(circle, #1a0000 0%, #000000 80%)";
            msg.innerHTML = '';
            sub.innerHTML = '';
        }
    </script>
</body>
</html>
